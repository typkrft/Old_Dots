#!/bin/sh

# TODO: ADD add Paths and Universally Used Variables out of function scope

export PATH=$PATH:/opt/homebrew/bin
export PATH=$PATH:/usr/local/bin
export PATH=$PATH:$HOME/.go/bin
export PATH=$PATH:$HOME/.config/bin
export PATH=$PATH:/Applications/kitty.app/Contents/MacOS
export PATH=$PATH:/opt/homebrew/sbin
export PATH=$PATH:/usr/local/opt/python/libexec/bin
export PATH=$PATH:$HOME/Library/Python/3.7/bin

# H E L P E R  F U N C T I O N S

# S K H D
# N O R M A L  M O D E 
function normal_mode() {
  echo "N O R M A L  M O D E";

  # C O L O R S
  . $HOME/.cache/wal/colors.sh;
  
  # Y A B A I
  yabai -m config active_window_border_color 0xff${color1:1};
  yabai -m config normal_window_border_color 0xff${color3:1};
  yabai -m config insert_feedback_color 0xff${color5:1};

  # S P A C B A R
  # spacebar -m config center_shell off
  # spacebar -m config title on
  
  # spacebar -m config background_color 0xaa${background:1} 
  # spacebar -m config foreground_color 0xff${color1:1} 
  # spacebar -m config power_icon_color 0xff${color3:1} 
  # spacebar -m config battery_icon_color 0xff${color3:1} 
  # spacebar -m config dnd_icon_color 0xff${color3:1} 
  # spacebar -m config clock_icon_color 0xff${color3:1} 
  # spacebar -m config right_shell_icon_color 0xff${color3:1} 
  # spacebar -m config space_icon_color 0xff${color3:1} 
  # spacebar -m config space_icon_color_secondary 0xff${color4:1} 
  # spacebar -m config space_icon_color_tertiary 0xff${color5:1} 

  # S K E T C H Y B A R 
  sketchybar -m config bar_color 0xF0${background:1}
  sketchybar -m set window_title script "~/.config/sketchybar/plugins/windowTitle.sh"
  sketchybar -m set window_title label "$( [[ $(yabai -m query --windows --window | jq '.title' | cut -c 1-50 | sed -E 's/"(.*)"/\1/') != "" ]] && yabai -m query --windows --window | jq '.title' | cut -c 1-50 | sed -E 's/"(.*)"/\1/' || yabai -m query --windows --window | jq '.app' | cut -c 1-50 | sed -E 's/"(.*)"/\1/')"
}

# W I N D O W  M O D E
function window_mode() {
  echo "W I N D O W  M O D E";    

  # C O L O R S
  . $HOME/.cache/wal/colors.sh;

  # Y A B A I
  yabai -m config active_window_border_color 0xff${color3:1};
  yabai -m config normal_window_border_color 0xff${color3:1};
  yabai -m config insert_feedback_color 0xff${color3:1};
  
  # S P A C B A R
  # spacebar -m config center_shell_command "echo \"W I N D O W  M O D E\"" 
  # spacebar -m config title off 
  # spacebar -m config center_shell on 
  
  # spacebar -m config background_color 0xaa${color3:1};
  # spacebar -m config foreground_color 0xff${foreground:1};
  # spacebar -m config power_icon_color 0xff${color3:1};
  # spacebar -m config battery_icon_color 0xff${color3:1};
  # spacebar -m config dnd_icon_color 0xff${color3:1};
  # spacebar -m config clock_icon_color 0xff${color3:1};
  # spacebar -m config right_shell_icon_color 0xff${color3:1};
  # spacebar -m config space_icon_color 0xff${color3:1};
  # spacebar -m config space_icon_color_secondary 0xff${color4:1};
  # spacebar -m config space_icon_color_tertiary 0xff${color5:1};

  # S K E T C H Y B A R 
  sketchybar -m config bar_color 0xF0${color3:1}
  sketchybar -m set window_title script ""
  sketchybar -m set window_title label "W I N D O W  M O D E"
}

# S C R I P T S  M O D E
function scripts_mode() {
  echo "S C R I P T S  M O D E";

  # C O L O R S
  . $HOME/.cache/wal/colors.sh;
  
  # Y A B A I
  yabai -m config active_window_border_color 0xff${color5:1};
  yabai -m config normal_window_border_color 0xff${color5:1};
  yabai -m config insert_feedback_color 0xff${color5:1};

  # S P A C B A R
  # spacebar -m config center_shell_command "echo \"S C R I P T S  M O D E\""
  # spacebar -m config title off 
  # spacebar -m config center_shell on

  # spacebar -m config background_color 0xaa${color5:1};
  # spacebar -m config foreground_color 0xff${foreground:1};
  # spacebar -m config power_icon_color 0xff${color5:1};
  # spacebar -m config battery_icon_color 0xff${color5:1};
  # spacebar -m config dnd_icon_color 0xff${color5:1};
  # spacebar -m config clock_icon_color 0xff${color5:1};
  # spacebar -m config right_shell_icon_color 0xff${color5:1};
  # spacebar -m config space_icon_color 0xff${color5:1};
  # spacebar -m config space_icon_color_secondary 0xff${color6:1};
  # spacebar -m config space_icon_color_tertiary 0xff${color7:1};

  # S K E T C H Y B A R 
  sketchybar -m config bar_color 0xF0${color5:1}
  sketchybar -m set window_title script ""
  sketchybar -m set window_title label "S C R I P T S  M O D E"

}

# S E T  W A L L P A P E R
#TODO: CHECK IF this still works
function set_wallpaper() {
  CURRENT_DESKTOP=$(yabai -m query --spaces | grep -a5 \"focused\":1 | grep index | sed -r 's/.*([[:digit:]]).*/\1/')
  TOTAL_SPACES=$(yabai -m query --spaces | jq '.[]|.["native-fullscreen"]' | grep -c 0)
  
  if [[ $1 = "" ]]; then
    WALLPAPER=$(osascript -e "tell application \"Finder\" to set wallpaper to get POSIX path of (get desktop picture as alias)")
  elif [[ $1 != "" ]]; then
    WALLPAPER=$1
  fi

  [[ $CURRENT_DESKTOP -ne 1 ]] && yabai -m space --focus 1 || :

  for SPACE in $(seq 1 $TOTAL_SPACES)
    do
      yabai -m space --focus $SPACE
      echo $SPACE
      sleep .25
      osascript -e "tell application \"Finder\" to set desktop picture to POSIX file \"$WALLPAPER\""
    done
  yabai -m space --focus $CURRENT_DESKTOP
}

function shuffle_wallpaper(){
  find /Volumes/Wallpapers -type f -print0 | \
  shuf -z -n 1| \
  xargs -I{} \
  osascript -e "tell application \"Finder\" to set desktop picture to POSIX file \"{}\""
}

# T O G G L E  S E R V I C E S
function toggle_service() {
  SERVICE=$1

  case $SERVICE in
    yabai) 
      # Yabai requires full forumla in service commands
      [[ $SERVICE == "yabai" ]] && YABAI=xorpse/formulae/yabai || :;
      # Other Services Start/Stop
      pgrep $SERVICE && brew services stop $YABAI || brew services start $YABAI;
    ;;
    skhd) 
      # Don't stop SKHD
      if [[ $SERVICE == "skhd" ]]; then
        brew services restart skhd;
      fi
    ;;
    spacebar)
      pgrep $SERVICE && brew services stop $SERVICE || brew services start $SERVICE;
      sleep .25;
      pgrep spacebar && yabai -m config external_bar main:$(spacebar -m config height):0 || yabai -m config external_bar main:0:0;
    ;;
    *) echo default
      pgrep $SERVICE && brew services stop $SERVICE || brew services start $SERVICE;
    ;;
  esac
  sleep .25;
  scripts_mode
}

# TODO: Add Save Colorscheme
# TODO: Add Cycle Favorite Colorshemes
# TODO: Keybindings for saturation and backends
function update_colors() {
    case $1 in
        c) # Current Wallpaper Colorscheme            
            CURRENT_WALLPAPER=$(osascript -e "tell application \"Finder\" to set wallpaper to get POSIX path of (get desktop picture as alias)")
            wal --backend schemer2 --saturate 1.0 -n -i "$CURRENT_WALLPAPER"
            ;;
        n) # New Walllpaper Colorscheme
            shuffle_wallpaper
            CURRENT_WALLPAPER=$(osascript -e "tell application \"Finder\" to set wallpaper to get POSIX path of (get desktop picture as alias)")
            wal -n --backend schemer2 --saturate 1.0 -i "$CURRENT_WALLPAPER"
            ;;
        s) # Keep Wallpaper, Shuffle Colorsheme
            wal -n --backend schemer2 --saturate 1.0 --recursive -i /Volumes/Wallpapers
            ;;
        S) # Save Scheme
            ;;
        f) # Cycle Favorite Schemes
            ;;
        *) 
            echo default
            ;;
    esac


    # Update Various App Colorschemes
    osascript -e "tell application \"Alfred 4\" to set theme \"Wal\""
    pywalfox update
    kitty @ --to="tcp:localhost:54889" set-colors -a -c $HOME/.config/kitty/kitty.conf 
    scripts_mode 
}

# S P A C E B A R
# M U S I C
# NOTE: Sure how to dynamically change the Player Icon
function spacebar_music_info() {

    PLAYER_STATE=$(osascript -e "tell application \"Music\" to set playerState to (get player state) as text") || echo
    TITLE=$(osascript -e "tell application \"Music\" to set theTrack to get name of current track") || echo
    ARTIST=$(osascript -e "tell application \"Music\" to set theTrack to get artist of current track")
    ALBUM=$(osascript -e "tell application \"Music\" to set theTrack to get album of current track") || echo
    
    if [[ $PLAYER_STATE == "stopped" ]]; then
        printf " Music Stopped "
        return 0
    elif [[ $PLAYER_STATE == "paused" ]]; then
    printf " $TITLE x $ARTIST" # Should probably manipulate this text and show the album as well if line is x characters eg | cut -c 1-80 or something more intelligent 
        return 1
    elif [[ $PLAYER_STATE == "playing" ]]; then
    printf " $TITLE x $ARTIST" # Should probably manipulate this text and show the album as well if line is x characters eg | cut -c 1-80 or something more intelligent 
        return 2
    else
        return 3
    fi    
}

# V P N 
function spacebar_vpn_info() {
    if [[ $(scutil --nc list | grep Connected) ]]; then
        VPN_NAME=$(scutil --nc list| sed -r 's/.*"(.*)".*/\1/'|tail -n1);
        printf " $VPN_NAME Connected ";
    else
        printf " No VPN Connected "
    fi
}

# I N V E S T M E N T S
function spacebar_investment_info() {
    ETH=$(/usr/bin/curl -s 'rate.sx/eth@1d' | /usr/bin/grep change| /usr/bin/sed -r 's/.*\((.*)\).*/\1/' | /opt/homebrew/bin/strip-ansi); 

    BTC=$(/usr/bin/curl -s 'rate.sx/btc@1d' | /usr/bin/grep change| /usr/bin/sed -r 's/.*\((.*)\).*/\1/' | /opt/homebrew/bin/strip-ansi); 

    VTI=$(/usr/bin/curl -s https://terminal-stocks.herokuapp.com/VTI | /usr/bin/grep - | head -n1 | /opt/homebrew/bin/strip-ansi |/usr/local/opt/python@3.9/libexec/bin/python -c "import sys,re;[sys.stdout.write(re.sub('│.*?│.*?│.*?│\w*?(.*?)\w*?│.*', r'\1', line)) for line in sys.stdin]" | /usr/bin/sed 's/ //g');     

    echo " BTC: $BTC ETH: $ETH VTI: $VTI%" | strip-ansi | rev | cut -c2-| rev | /usr/bin/sed -e 's/$/\%/g'
}

# S P A C E B A R  C M D  S E L E C T
function spacebar_cmd_select() {
    current_selection=$(spacebar -m config right_shell_command)
    if [[ $current_selection == *"-m"* ]]; then
       spacebar -m config right_shell_icon '| '
       spacebar -m config right_shell_command "$HOME/.config/bin/helpers -v;"
    elif [[ $current_selection == *"-v"* ]]; then
       spacebar -m config right_shell_icon '| '
       spacebar -m config right_shell_command "echo" # Delay before information displayed 
       spacebar -m config right_shell_command "$HOME/.config/bin/helpers -i;"
    elif [[ $current_selection == *"-i"* ]]; then
        # spacebar_music_info
        # PLAYER_STATE=$?
        # if [[ ${PLAYER_STATE} -eq 0 ]]; then
        #     $HOMEBREW/spacebar -m config right_shell_icon '| '
        # elif [[ ${PLAYER_STATE} -eq 1 ]]; then
        #     $HOMEBREW/spacebar -m config right_shell_icon '| '        
        # elif [[ ${PLAYER_STATE} -eq 2 ]]; then
        #     $HOMEBREW/spacebar -m config right_shell_icon '| '
        # else
        #     $HOMEBREW/spacebar -m config right_shell_icon '| '
        # fi
       spacebar -m config right_shell_icon '| '
       spacebar -m config right_shell_command "$HOME/.config/bin/helpers -m;" 
    fi
}

# Y A B A I
# TODO: Make a layout and stack indicator
# C L O S E  W I N D O W S
function close_window() {
  if [[ $(yabai -m query --windows --window |grep \"native-fullscreen\":1) ]]; then
    yabai -m window --toggle native-fullscreen;
    yabai -m window --close;
    skhd -k "escape";
  else
    yabai -m window --close;
  fi
}
# T O G G L E  G A P S  A N D  B O R D E R S
function toggle_gabs_and_borders() {
  if [[ $(yabai -m config window_border) == on ]]; then
    yabai -m space --toggle gap;
    yabai -m space --toggle padding;
  elif [[ $(yabai -m config window_border) == off ]]; then
    yabai -m space --toggle gap;
    yabai -m space --toggle padding;
    yabai -m config window_border on;
  fi
  skhd -k "escape"
}
# T O G G L E  W I N D O W  L A Y O U T S
function toggle_layouts(){
  if [[ $(yabai -m query --spaces | jq '[.[]|select(.focused==1)][0].type') == *"bsp"* ]]; then
    yabai -m query --spaces \
    | jq '[.[]|select(.focused==1)][0].index' \
    | xargs -I {} yabai -m space {} --layout stack;
  elif [[ $(yabai -m query --spaces | jq '[.[]|select(.focused==1)][0].type') == *"stack"* ]]; then
    yabai -m query --spaces \
    | jq '[.[]|select(.focused==1)][0].index' \
    | xargs -I {} yabai -m space {} --layout float;
  elif [[ $(yabai -m query --spaces | jq '[.[]|select(.focused==1)][0].type') == *"float"* ]]; then \
    yabai -m query --spaces \
    | jq '[.[]|select(.focused==1)][0].index' \
    | xargs -I {} yabai -m space {} --layout bsp; \
  fi
}

# I N S E R T  A P P  W I N D O W S  I N T O  S T A C K
# TODO: setup function so any app can do this. 
function kitty_quake() {
  QUAKE=($(yabai -m query --windows --space |jq '.[]|select(.title=="Quake")|.id,.minimized,.border'))
  echo "1) ${QUAKE[0]} 2) ${QUAKE[1]} 3) ${QUAKE[2]} 4) ${QUAKE[3]} 5) ${QUAKE[4]} 6) ${#QUAKE[@]}"
  if [[ ${#QUAKE} -eq 0 ]]; then
    open -a kitty.app -n --args -1 --title="Quake"
    while [[ ${#QUAKE[@]} -ne 3 ]];
      do
        QUAKE=($(yabai -m query --windows --space|jq '.[]|select(.title=="Quake")|.id,.minimized,.border'))
        echo ${QUAKE[0]} ${QUAKE[1]} ${QUAKE[2]}
      done
    yabai -m window "${QUAKE[0]}" --toggle sticky;
    yabai -m window "${QUAKE[0]}" --move abs:0:0;
    yabai -m window "${QUAKE[0]}" --resize abs:10000:450;
    yabai -m window "${QUAKE[0]}" --opacity 0.95;
  elif [[ ${QUAKE[1]} -eq 1 ]]; then
    yabai -m window "${QUAKE[0]}" --deminimize;
    yabai -m window "${QUAKE[0]}" --move abs:0:0;
    yabai -m window "${QUAKE[0]}" --resize abs:10000:450;
    yabai -m window "${QUAKE[0]}" --opacity 0.95;
    yabai -m window "${QUAKE[0]}" --focus "${QUAKE[0]}";
    [[ ${QUAKE[2]} -eq 0 ]] && yabai -m window "${QUAKE[0]}" --toggle border || :
  elif [[ ${QUAKE[1]} -eq 0 ]]; then
    [[ ${QUAKE[2]} -eq 1 ]] && yabai -m window "${QUAKE[0]}" --toggle border || :
    yabai -m window "${QUAKE[0]}" --opacity 0.001;
    yabai -m window "${QUAKE[0]}" --minimize;
  else
    echo quake failed
  fi
}

# TODO: Setup a title filter instead of hard coding it just for kitty
function stack_app() {
  APP_TO_STACK="$*"
  CURRENT_APP="$(yabai -m query --windows --window | jq '.app' | sed -E 's/"(.*)"/\1/')"
  WINDOW_TITLE=$(yabai -m query --windows --window | jq '.title' | sed -E 's/"(.*)"/\1/')
  
  if [[ $APP_TO_STACK == $CURRENT_APP ]]; then
    if [[ $CURRENT_APP == "kitty" ]]; then
      if [[ $WINDOW_TITLE == "Quake" ]]; then
        open -a kitty.app -n --args -1 --title="Kitty"
        exit 0
      fi
    fi
    yabai -m window --insert stack
    osascript -e "tell application \"System Events\" to tell application process \"$CURRENT_APP\" to tell menu 1 of menu bar item 3 of menu bar 1 to click (first menu item whose value of attribute \"AXMenuItemCmdChar\" is \"N\" and value of attribute \"AXMenuItemCmdModifiers\" is 0)"
  fi
}

# C R E A T E  S P A C E S
# TODO: Create another function that runs hack if neccessary else native
function create_spaces() {
    TOTAL_SPACES=$(yabai -m query --spaces | jq '.[]|.["native-fullscreen"]' | grep -c 0)
    DESIRED_SPACES=$1
    SPACES_TO_CREATE=$(($DESIRED_SPACES - $TOTAL_SPACES))
    echo $SPACES_TO_CREATE

    if [[ ${SPACES_TO_CREATE} -le 0 ]]; then
        echo "$TOTAL_SPACES are available."
        exit 0
    elif [[ ${SPACES_TO_CREATE} -gt 0 ]]; then
        for space in ${SPACES_TO_CREATE}
            do 
              yabai -m space --create;
            done
    fi
}

# S I P  H A C K S 
# C R E A T E  S P A C E S
function create_spaces_hack() {
    TOTAL_SPACES=$(($(yabai -m query --spaces | grep -c "id") - $(yabai -m query --spaces | grep -c '"native-fullscreen":1')))
    ARGS=$(echo "${*} $TOTAL_SPACES")

    osascript - "${ARGS}" <<EOF
    on run argv
        set argv to argv as string
        set argv to words of argv

        set desired_spaces to item 1 of argv as number
        set additional_or_total to item 2 of argv as boolean -- true is total
        set total_spaces to item 3 of argv as number
        
        if additional_or_total is true and desired_spaces < total_spaces then
            -- look for empty spaces to remove maybe
            tell me to "exit"
        else if additional_or_total is true and desired_spaces > total_spaces then
            repeat desired_spaces - total_spaces times
                do shell script "open -a 'Mission Control'"
                delay 0.1
                tell application "System Events" to click (every button whose value of attribute "AXDescription" is "add desktop") of UI element "Spaces Bar" of UI element 1 of group 1 of process "Dock"
                delay 0.1
                do shell script "open -a 'Mission Control'"
            end repeat
        else if additional_or_total is false then
            repeat desired_spaces times
                do shell script "open -a 'Mission Control'"
                delay 0.1
                tell application "System Events" to click (every button whose value of attribute "AXDescription" is "add desktop") of UI element "Spaces Bar" of UI element 1 of group 1 of process "Dock"
                delay 0.1
                do shell script "open -a 'Mission Control'"
            end repeat
        end if
    end run
EOF
}

# M O V E  S P A C E S
# TODO: Needs check for out of bounds e.g.: move to 100 or -1
function move_spaces_hack() {
    CURRENT_DESKTOP=$($HOMEBREW/yabai -m query --spaces | grep -a5 \"focused\":1 | grep index | sed -r 's/.*([[:digit:]]).*/\1/')
    DESIRED_DESKTOP=$1
    ARGS="$CURRENT_DESKTOP $DESIRED_DESKTOP"

    osascript - "${ARGS}" <<EOF
    on run argv
        set argv to argv as string
        set argv to words of argv
        set current_space to item 1 of argv as integer
        set desired_space to item 2 of argv as integer

        if desired_space - current_space < 0 then
		set a to desired_space - current_space
		set a to a as string
		set moves to item 2 of a as integer
		tell application "System Events"
			repeat moves times
				key code 123 using control down
				delay 0.1
			end repeat
		end tell
	else if desired_space - current_space > 0 then
		tell application "System Events"
			repeat desired_space - current_space times
				key code 124 using control down
				delay 0.1
			end repeat
		end tell
	else if desired_space - current_space is 0 then
		-- log "Desired Desktop is Current Desktop"
	else
		-- log "failed"
	end if
    end run
EOF
}

# M I S C
# V P N
# TODO: Work on colors and add VPN Center Title
function toggle_vpn() {
  skhd -k "escape"; 
  VPN_STATUS=$(networksetup -showpppoestatus "Myrtle Beach Office VPN")
  if [[ $VPN_STATUS == "disconnected"  ]]; then
    networksetup -connectpppoeservice "Myrtle Beach Office VPN";
    spacebar -m config right_shell_icon '| '
    spacebar -m config right_shell_command "$HOME/.config/bin/helpers -v"
  elif [[ $VPN_STATUS == "connected"  ]]; then
    networksetup -disconnectpppoeservice "Myrtle Beach Office VPN";
    normal_mode
  fi; 
}

# Unused - No longer needed
function kitty_quake_tab() {
  QUAKE=($(yabai -m query --windows --window | jq '.|.id,.focused,.title'| sed -E 's/"(.*)"/\1/'))

  if [[ ${QUAKE[2]} == "Quake" ]]; then
    echo test
    kitty @ --to="tcp:localhost:54889" launch --type=tab --window-title "Quake" --tab-title="Quake: {index}"
  else
    echo test2
    skhd -k "ctrl + shift - t"
  fi
}

# P A R S E  O P T S
# For GETOPT : = required param :: = optional param 
# For GETOPTS just use $2 if you need an optional param
while getopts "nwsmvict:S:M:w:C:WpP:VlgxT:Qq" flag
do
  case "${flag}" in
    n) 
      normal_mode
      ;;
    w) 
      window_mode
      ;;
    s) 
      scripts_mode
      ;;
    m) 
      spacebar_music_info
      ;;
    v) 
      spacebar_vpn_info
      ;;
    i) 
      spacebar_investment_info
      ;;
    c) 
      spacebar_cmd_select
      ;;
    t) 
      toggle_service ${OPTARG}
      ;;
    S) 
      create_spaces_hack ${OPTARG}
      ;;
    M) 
      move_spaces_hack ${OPTARG}
      ;;
    C)
      create_spaces ${OPTARG}
      ;;
    W)
      set_wallpaper $2
      ;;
    p)
      shuffle_wallpaper
      ;;
    P) 
      update_colors ${OPTARG}
      ;;
    V) 
      toggle_vpn
      ;;
    l) 
      toggle_layouts
      ;;
    g) 
      toggle_gabs_and_borders
      ;;
    x) 
      close_window
      ;;
    T) 
      stack_app ${OPTARG}
      ;;
    Q) 
      kitty_quake
      ;;
    q)  
      kitty_quake_tab
      ;;
    *) 
      echo "Invalid option: -$flag" 
      ;;
  esac
done
